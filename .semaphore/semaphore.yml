version: v1.0

name: Check status service

agent:
  machine:
    type: e1-standard-2

  containers:
    - name: main
      image: semaphoreci/haskell:8.6

blocks:

  - name: Set up
    dependencies: []
    task:
      env_vars:
        - name: STACK_ROOT
          value: /root/check-status/.stack-root

      prologue:
        commands:
          - checkout
          - mkdir -p $STACK_ROOT
          - cache restore stack-cache-2-$(checksum package.yaml)-$(checksum stack.yaml)

      jobs:
        - name: Setup GHC and dependencies
          commands:
            - stack setup
            - stack build --dependencies-only
            - cache store stack-cache-2-$(checksum package.yaml)-$(checksum stack.yaml) .stack-root

  - name: Binaries
    dependencies: ["Set up"]
    task:
      env_vars:
        - name: STACK_ROOT
          value: /root/check-status/.stack-root

      prologue:
        commands:
          - checkout
          - mkdir -p $STACK_ROOT
          - cache restore stack-cache-2-$(checksum package.yaml)-$(checksum stack.yaml)

      jobs:
        - name: Test
          commands:
            - stack build --test

        - name: Build and install
          commands:
            - stack --local-bin-path dest install
            - cache store binaries-$SEMAPHORE_PIPELINE_ARTEFACT_ID dest

  - name: Docker image
    dependencies: ["Binaries"]
    task:
      secrets:
        - name: dockerhub-secrets

      prologue:
        commands:
          - checkout
          - cache restore binaries-$SEMAPHORE_PIPELINE_ARTEFACT_ID
          - echo "${DOCKER_PASSWD}" | docker login -u "${DOCKER_USER}" --password-stdin

      jobs:
        - name: Build image
          commands:
            - docker build -t magthe/check-status:semaphore-${SEMAPHORE_GIT_BRANCH} .
            - docker tag magthe/check-status:semaphore-${SEMAPHORE_GIT_BRANCH} magthe/check-status:semaphore-${SEMAPHORE_GIT_BRANCH}-${SEMAPHORE_WORKFLOW_ID}
            - docker push magthe/check-status
